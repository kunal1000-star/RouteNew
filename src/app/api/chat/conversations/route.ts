// Conversation Management API Endpoints\n// ====================================\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nfunction getDbForRequest(request: NextRequest) {\n  const authHeader = request.headers.get('authorization');\n  if (!authHeader || !authHeader.startsWith('Bearer ')) return null;\n  const token = authHeader.substring(7);\n  return createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    { global: { headers: { Authorization: `Bearer ${token}` } } }\n  );\n}\n\nconst UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n\n// GET /api/chat/conversations - List conversations for current user\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const chatType = searchParams.get('chatType');\n\n    const db = getDbForRequest(request);\n    if (!db) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Derive authenticated user from Supabase JWT\n    const { data: authData, error: authError } = await db.auth.getUser();\n    if (authError || !authData?.user) {\n      return NextResponse.json({ error: 'Unauthorized: invalid or missing token' }, { status: 401 });\n    }\n    const userId = authData.user.id;\n\n    if (!UUID_REGEX.test(userId)) {\n      return NextResponse.json({ error: 'Invalid authenticated user id: must be a UUID' }, { status: 400 });\n    }\n    const effectiveUserId = userId;\n\n    let query = db\n      .from('chat_conversations')\n      .select('id, title, chat_type, created_at, updated_at, is_archived')\n      .eq('user_id', effectiveUserId)\n      .eq('is_archived', false)\n      .order('updated_at', { ascending: false });\n\n    if (chatType) {\n      query = query.eq('chat_type', chatType);\n    }\n\n    const { data: conversations, error } = await query;\n\n    if (error) {\n      throw new Error(`Failed to fetch conversations: ${error.message}`);\n    }\n\n    return NextResponse.json({ conversations });\n  } catch (error) {\n    console.error('Get conversations error:', error);\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST /api/chat/conversations - Create new conversation for current user\nexport async function POST(request: NextRequest) {\n  try {\n    const { title, chatType } = await request.json();\n\n    const db = getDbForRequest(request);\n    if (!db) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    if (!chatType) {\n      return NextResponse.json(\n        { error: 'Missing required field: chatType' },\n        { status: 400 }\n      );\n    }\n\n    // Derive authenticated user\n    const { data: authData, error: authError } = await db.auth.getUser();\n    if (authError || !authData?.user) {\n      return NextResponse.json({ error: 'Unauthorized: invalid or missing token' }, { status: 401 });\n    }\n    const userId = authData.user.id;\n\n    if (!UUID_REGEX.test(userId)) {\n      return NextResponse.json({ error: 'Invalid authenticated user id: must be a UUID' }, { status: 400 });\n    }\n    const effectiveUserId = userId;\n\n    const conversationTitle = title || 'New Conversation';\n\n    const { data: conversation, error } = await db\n      .from('chat_conversations')\n      .insert({\n        user_id: effectiveUserId,\n        title: conversationTitle,\n        chat_type: chatType\n      })\n      .select()\n      .single();\n\n    if (error) {\n      throw new Error(`Failed to create conversation: ${error.message}`);\n    }\n\n    return NextResponse.json({\n      conversation: {\n        id: conversation.id,\n        title: conversation.title,\n        chat_type: conversation.chat_type,\n        created_at: conversation.created_at,\n        updated_at: conversation.updated_at\n      }\n    });\n\n  } catch (error) {\n    console.error('Create conversation error:', error);\n    return NextResponse.json(\n      { error: error instanceof Error ? error.message : 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n